from airflow import DAG
from airflow.operators.python import PythonOperator
from datetime import datetime
import pandas as pd
from io import BytesIO
from minio import Minio


BRONZE_BUCKET = "bronze"
SILVER_BUCKET = "silver"



def transform_bronze_to_silver():
    # ðŸ”¹ Garante que o bucket silver exista
    if not MINIO_CLIENT.bucket_exists(SILVER_BUCKET):
        MINIO_CLIENT.make_bucket(SILVER_BUCKET)

    # ðŸ”¹ LÃª o arquivo bruto do MinIO
    obj = MINIO_CLIENT.get_object(BRONZE_BUCKET, BRONZE_FILE)
    df = pd.read_csv(obj)

    # ðŸ”¹ Remove linhas com valores nulos
    df = df.dropna()

    # ðŸ”¹ Normaliza os nomes das colunas
    df.columns = df.columns.str.lower().str.strip().str.replace(" ", "_")

    # ðŸ”¹ NormalizaÃ§Ã£o da coluna 'tp'
    if "tp" in df.columns:
        df["tp"] = df["tp"].astype(str).str.replace("TERM\\.", "terminal", regex=True)

    # ðŸ”¹ NormalizaÃ§Ã£o da coluna 'sl'
    if "sl" in df.columns:
        df["sl"] = df["sl"].replace({"1": "ida", "2": "volta", 1: "ida", 2: "volta"})

    # ðŸ”¹ NormalizaÃ§Ã£o da coluna 'lc'
    if "lc" in df.columns:
        df["lc"] = df["lc"].replace({False: "nÃ£o", True: "sim", "false": "nÃ£o", "true": "sim"})

    # ðŸ”¹ Salva resultado em CSV
    data = df.to_csv(index=False).encode("utf-8")

    # ðŸ”¹ Envia o arquivo transformado para a camada Silver
    MINIO_CLIENT.put_object(
        bucket_name=SILVER_BUCKET,
        object_name=SILVER_FILE,
        data=BytesIO(data),
        length=len(data),
       
    )


with DAG(
    dag_id="bronze_to_silver_dag",
    start_date=datetime(2024, 1, 1),
    schedule_interval=None,
    catchup=False,
    tags=["minio", "silver", "transform"],
) as dag:

    task_transform = PythonOperator(
        task_id="transform_bronze_to_silver",
        python_callable=transform_bronze_to_silver
    )
